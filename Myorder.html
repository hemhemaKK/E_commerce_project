<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Order Details</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        body {
            background-color: antiquewhite;
        }

        #logo video {
            height: 100px;
        }

        #logout-container {
            display: flex;
            justify-content: space-between;
            background-color: white;
            margin-top: -105px;
        }

        #logout-container h2 {
            margin-left: 100px;
        }

        #logout-container button {
            background-color: rgb(255, 55, 0);
            padding: 10px;
            width: 80px;
            height: 40px;
            margin-top: 20px;
            margin-right: 20px;
            border-radius: 10px;
            font-size: medium;
            font-weight: bold;
            border: none;
            color: aliceblue;
        }

        #logout-container button:hover {
            background-color: burlywood;
        }

        #container_nav {
            width: 60%;
            margin-left: 20%;
            margin-top: -100px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.9);
            background-color: #e6e0ff;
        }

        .nav-bar ul {
            display: flex;
            list-style-type: none;
            justify-content: center;
            padding: 15px 0;
            flex-wrap: wrap;
            gap: 30px;
        }

        .nav-bar ul li a {
            text-decoration: none;
            color: #000;
            font-weight: bold;
            font-size: 1.1em;
        }

        #orderList {
            margin: auto;
            width: 80%;
            background-color: antiquewhite;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            padding: 20px;
            gap: 40px;
        }

        .ordercard {
            width: 98%;
            padding: 10px;
            background-color: aliceblue;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            border-radius: 10px;
        }

        .ordercard img {
            height: 100px;
            width: 100px;
        }

        .stars {
            color: rgb(196, 157, 0);
            font-size: 24px;
        }

        .comments h2 {
            background-color: rgb(27, 0, 80);
            color: aliceblue;
            padding: 5px;
            font-size: 16px;
        }

        #containerprice {
            background-color: white;
            margin: auto;
            width: 40%;
            padding: 5px;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            font-size: large;
        }

        .feedback-form {
            margin-top: 10px;
        }

        .feedback-form select,
        .feedback-form textarea,
        .feedback-form button {
            width: 90%;
            margin-top: 5px;
            padding: 6px;
            border-radius: 6px;
        }

        .feedback-form button {
            background-color: #4caf50;
            color: white;
            font-weight: bold;
            border: none;
            cursor: pointer;
        }

        .feedback-form button:hover {
            background-color: #45a049;
        }

        .order-user-details,
        .payment-details {
            margin-top: 10px;
            padding: 8px;
            background-color: #f9f9f9;
            border-left: 4px solid #ccc;
        }

        /* ------------------- Responsive Media Queries ------------------- */
        @media screen and (max-width: 1024px) {
            header {
                flex-direction: row;
                justify-content: space-between;
            }


            #container_nav {
                width: 65%;
                margin-top: 10px;
            }
            #logout-container{
              height: 100px;
            }

            #logout-container h2 {
                font-size: 1.3em;
            }
            .ordercard img{
                height: 100px;
                width: 100px;
            }
            #orderList {
                width: 80%;
                grid-template-columns: repeat(3, 1fr);
                padding: 20px;
            }

        }

        @media screen and (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: center;
            }

            #logout-container {
                justify-content: center;
                gap: 10px;
                margin-top: -110px;
                height: 110px;
            }

            #logout-container h2 {
                margin-left: 70px;
                text-align: center;
            }

            #logout-container button {
                margin-left: 100px;
                text-align: center;
            }

            #container_nav {
                width: 65%;
                margin-top: 10px;
            }

            .nav-bar ul {
                gap: 15px;
                padding: 10px;
            }

            .nav-bar ul li a {
                font-size: 1em;
            }


            .ordercard img {
                height: 180px;
            }

            #orderList {
                width: 80%;
                grid-template-columns:repeat(2, 1fr);
                padding: 20px;
            }

        }

        @media screen and (max-width: 480px) {
            #logo video {
                height: 60px;
            }

            .nav-bar ul {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            .nav-bar ul li a {
                font-size: 0.95em;
            }

            #orderList {
                width: 80%;
                grid-template-columns: 1fr;
                padding: 20px;
            }

            .ordercard img {
                height: 100px;
            }

            #containerprice {
                width: 95%;
                font-size: 1em;
            }
        }

        @media screen and (max-width: 768px) {
            .ordercard h3 {
                font-size: 1em;
            }

            #orderList {
                width: 90%;
                grid-template-columns: 1fr;
                padding: 20px;
            }
            .ordercard img{
                height: 100px;
                width: 100px;
            }

            .order-user-details,
            .payment-details {
                font-size: 0.85em;
            }

            .stars {
                font-size: 16px;
            }
        }

        @media screen and (max-width: 480px) {
            .ordercard {
                padding: 10px;
            }
            .ordercard img {
                max-height: 180px;
            }

            .feedback-form select,
            .feedback-form textarea,
            .feedback-form button {
                font-size: 0.9em;
            }

            .cancel-btn {
                font-size: 0.85em;
            }
        }
    </style>
</head>

<body>
    <div id="logo">
        <video autoplay muted loop playsinline>
            <source src="./images/logo.mp4" type="video/mp4" />
        </video>
    </div>

    <div id="logout-container">
        <h2>
            <font size="6px">E-Shoppy</font> <br> Shop Anywhere
        </h2>
        <button id="logout-btn">Logout</button>
    </div>

    <div id="container_nav">
        <nav class="nav-bar">
            <ul>
                <li><a href="User_dashboard.html">Home</a></li>
                <li><a href="Myorder.html">My orders</a></li>
                <li><a href="User_dashboard.html">Store</a></li>
                <li>
                    <a href="order.html"><i class="fas fa-shopping-cart" class="cart-btn"
                            style="cursor:pointer;"></i></a>
                </li>
                <li><i class="fa-solid fa-heart"></i></li>
                <li><b><i class="fas fa-user-circle"></i>
                        <font color="green"><span id="user-email"></span></font>
                    </b></li>
            </ul>
        </nav>
    </div><br>

    <center>
        <h2>Keep Track on Your Orders......</h2>
    </center>
    <div id="orderList"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        import { getDatabase, ref, onValue, get, update } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDqfJUI0Orck3nDCB2Ulm-AgiZcWV92KcM",
            authDomain: "democheck-c2d99.firebaseapp.com",
            databaseURL: "https://democheck-c2d99-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "democheck-c2d99",
            storageBucket: "democheck-c2d99.appspot.com",
            messagingSenderId: "870409634136",
            appId: "1:870409634136:web:68bad3814e92012d7ae52d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const cardsContainer = document.querySelector('#orderList');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('user-email').innerText = user.email;

                onValue(ref(db, 'orders'), (snapshot) => {
                    const allOrders = [];
                    snapshot.forEach(order => {
                        const data = order.val();
                        if (data.buyerID === user.uid && (data.status !== "pending")) {
                            data.id = order.key;
                            allOrders.push(data);
                        }
                    });
                    displayOrders(allOrders, user);
                });

            } else {
                window.location.href = "index.html";
            }
        });

        function displayOrders(orders, user) {
            cardsContainer.innerHTML = '';
            let totalPrice = 0;
            let processed = 0;

            if (orders.length === 0) {
                cardsContainer.innerHTML = "<p>No orders found.</p>";
                return;
            }

            orders.forEach(data => {
                const productID = data.productID;
                get(ref(db, 'products/' + productID)).then(snapshot => {

                    const product = snapshot.val();
                    if (product) {
                        const price = parseFloat(product.price || 0);
                        const discount = parseFloat(product.discount || 0);
                        const discountedPrice = price * (1 - discount / 100);

                        const ratings = product.rating || [];
                        const avg = ratings.length > 0 ? ratings.reduce((a, b) => a + parseFloat(b), 0) / ratings.length : 0;
                        const stars = '‚òÖ'.repeat(Math.floor(avg)) + '‚òÜ'.repeat(5 - Math.floor(avg));
                        const comments = product.comments || [];
                        const address = data.address || "N/A";
                        const phone = data.phone || "N/A";
                        const payment = data.payment || {};
                        const isCancelled = data.status === "cancelled";
                        const isCOD = payment.method === "COD";
                        const isDelivered = data.status === "delivered";
                        const isPrepaid = payment.method === "Card" || payment.method === "UPI";

                        let finalPaymentStatus = "Not specified";
                        if (isCancelled) {
                            finalPaymentStatus = "refunded";
                        } else if (isCOD && !isDelivered) {
                            finalPaymentStatus = "pending";
                        } else if (isPrepaid) {
                            finalPaymentStatus = "paid";
                        } else {
                            finalPaymentStatus = payment.status || "Not specified";
                        }

                        const card = document.createElement('div');
                        card.className = 'ordercard';
                        card.innerHTML = `
              <img src="${product.image}" alt="${product.title}">
              <h3>${product.title}</h3>
              <p class="price">
                <span style="text-decoration: line-through; color: gray;">‚Çπ${price.toFixed(2)}</span>
                &nbsp;
                ‚Çπ${discountedPrice.toFixed(2)}
                <span style="color:red;"> (${discount}% OFF)</span>
              </p>
              <p>${product.description}</p>
              <p><b>Status:</b> ${data.status}</p>
              <p class="stars">${stars} (${avg.toFixed(1)})</p>
              <div class="order-user-details">
                <h4>üìç Delivery Info</h4>
                <p><b>Address:</b> ${address}</p>
                <p><b>Phone:</b> ${phone}</p>
             </div>
             <div class="payment-details">
                 <h4>üí≥ Payment Details</h4>
                  <p><b>Method:</b> ${payment.method}</p>
                 <p><b>Status:</b> ${finalPaymentStatus}</p>
                  <p><b>Transaction ID:</b> ${payment.transactionID || "N/A"}</p>
            </div>
                ${data.status === "delivered" ? `
                <form class="feedback-form">
                  <label>Rate this product:</label>
                  <select name="rating" required>
                    <option value="">Select</option>
                    <option value="1">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ</option>
                    <option value="2">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ</option>
                    <option value="3">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</option>
                    <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</option>
                    <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</option>
                  </select>
                  <label>Comment:</label>
                  <textarea name="comment" rows="2" placeholder="Your feedback..."></textarea>
                  <button type="submit">Submit</button>
                  </form>` : (data.status !== "cancelled" ? `
                              <button class="cancel-btn" style="margin-top: 10px; background-color: crimson; color: white; padding: 6px; border-radius: 5px; border: none; cursor: pointer;">
                               Cancel Order
                            </button>` : '')}
                `;

                        const cancelBtn = card.querySelector(".cancel-btn");
                        if (cancelBtn) {
                            cancelBtn.addEventListener("click", () => {
                                if (confirm("Are you sure you want to cancel this order?")) {
                                    const orderRef = ref(db, 'orders/' + data.id);
                                    update(orderRef, { status: "cancelled" })
                                        .then(() => {
                                            alert("Order cancelled.");
                                            location.reload(); // refresh to reflect the change
                                        })
                                        .catch(err => console.error("Failed to cancel order:", err));
                                }
                            });
                        }


                        cardsContainer.appendChild(card);

                        const form = card.querySelector('.feedback-form');
                        if (form) {
                            form.addEventListener('submit', (e) => {
                                e.preventDefault();
                                const ratingValue = parseInt(form.rating.value);
                                const commentText = form.comment.value.trim();

                                if (!ratingValue || !commentText) return;

                                const productRef = ref(db, 'products/' + productID);

                                get(productRef).then((snapshot) => {
                                    const productData = snapshot.val();
                                    const currentRatings = productData.rating || [];
                                    const currentComments = productData.comments || [];

                                    const newRatings = [...currentRatings, ratingValue];
                                    const newComments = [...currentComments, {
                                        user: user.email,
                                        text: commentText
                                    }];

                                    update(productRef, {
                                        rating: newRatings,
                                        comments: newComments
                                    }).then(() => {
                                        alert("Thank you for your feedback!");
                                        form.reset();
                                    });
                                });
                            });
                        }
                    }
                });
            });

            document.getElementById('logout-btn').addEventListener("click", async () => {
                await signOut(auth);
                alert("Logged out successfully");
                window.location.href = "index.html";
            });

            if (sessionStorage.getItem("role") !== "buyer") {
                window.location.href = "admin_dashboard.html";
            }
        }

    </script>
</body>

</html>
